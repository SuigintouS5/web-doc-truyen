{% load static %}

<div class="volume-manager">
    <div class="volume-header-main">
        <h2>Quản lý Volume & Chương</h2>
        <button type="button" id="openVolumeModal" class="btn-add-volume">
            <i class="fas fa-plus"></i> Thêm Volume
        </button>
    </div>

    <input type="hidden" id="currentTruyenId" value="{{ truyen.id }}">

    <div class="volume-list">
        {% for volume in truyen.volumes.all %}
        <div class="volume-card">
            <div class="volume-card-header">
                <div class="volume-info-group">
                    <span class="toggle-icon">❯</span>
                    <div class="text-details">
                        <h3 class="vol-name">
                            Vol {{ volume.so_volume }}
                            {% if volume.ten and volume.ten != volume.so_volume|stringformat:"s" and volume.ten != "Vol " %}
                                {% if "Vol" not in volume.ten %} - {{ volume.ten }}{% else %} - {{ volume.ten|cut:"Vol "|cut:"Vol" }}{% endif %}
                            {% endif %}
                        </h3>
                        <p class="vol-desc text-muted">{{ volume.mo_ta|default:"" }}</p>
                    </div>
                </div>
                <div class="volume-actions">
                    <button class="btn-action btn-add-chapter" data-volid="{{ volume.id }}">
                        <i class="fas fa-plus"></i> Thêm chương
                    </button>
                    <button class="btn-icon-only btn-edit-volume" data-id="{{ volume.id }}">
                        <i class="far fa-edit"></i>
                    </button>
                    <button class="btn-icon-only danger btn-delete-volume" data-id="{{ volume.id }}" data-name="Vol {{ volume.so_volume }}">
                        <i class="far fa-trash-alt"></i>
                    </button>
                </div>
            </div> 

            <div class="chapter-content-area hidden">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th width="10%">Số</th>
                            <th width="40%">Tên chương</th>
                            <th width="20%">Trạng thái</th>
                            <th width="30%">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for chuong in volume.chuongs.all %}
                        <tr>
                            <td class="text-muted">#{{ chuong.so_chuong }}</td>
                            <td>{{ chuong.ten }}</td>
                            <td><span class="badge badge-success" style="background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 12px;">● Công khai</span></td>
                            <td>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-icon-only btn-edit-chapter" data-id="{{ chuong.id }}" style="border: 1px solid #ddd; border-radius: 4px; padding: 4px 8px;">
                                        <i class="far fa-edit"></i>
                                    </button>
                                    <button class="btn-icon-only danger btn-delete-chapter" data-id="{{ chuong.id }}" data-name="{{ chuong.ten }}" style="border: 1px solid #fecaca; color: #ef4444; border-radius: 4px; padding: 4px 8px;">
                                        <i class="far fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="empty-state" style="text-align: center; padding: 20px; color: #9ca3af;">Chưa có chương nào.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% empty %}
        <div class="no-data" style="text-align: center; padding: 40px; color: #9ca3af;"><p>Chưa có volume nào.</p></div>
        {% endfor %}
    </div>
</div>

<div id="volumeModal" class="volume-modal hidden">
    <div class="modal-overlay"></div>
    <div class="volume-modal-content">
        <div class="modal-header"><h3 id="volModalTitle">Thêm Volume mới</h3></div>
        <div class="modal-body">
            <div style="margin-bottom: 15px;">
                <label>Tên Volume</label>
                <input type="text" id="volumeNameInput" placeholder="Ví dụ: Khởi đầu...">
            </div>
            <div style="margin-bottom: 20px;">
                <label>Mô tả</label>
                <textarea id="volumeDescInput" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button id="closeVolumeModal">Hủy</button>
            <button id="saveVolumeBtn" style="background: black; color: white;">Lưu</button>
        </div>
    </div>
</div>

<div id="chapterModal" class="volume-modal hidden">
    <div class="modal-overlay"></div>
    <div class="volume-modal-content" style="max-width: 800px; width: 95%;">
        <div class="modal-header" style="display: flex; justify-content: space-between;">
            <h3 id="chapterModalTitle">Thêm chương</h3>
            <span id="closeChapterX" style="cursor:pointer; font-size: 20px;">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-weight:600;">Số chương</label>
                <input type="number" id="chapterNoInput" style="width:100%; padding:10px; background:#f3f4f6; border:1px solid #ddd; border-radius:8px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-weight:600;">Tên chương <span style="color:red">*</span></label>
                <input type="text" id="chapterNameInput" placeholder="Nhập tên chương" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-weight:600;">Nội dung chương</label>
                <textarea id="chapterContentInput" rows="15" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; resize: vertical;"></textarea>
                <div id="wordCountDisplay" style="text-align: right; font-size: 13px; color: #6b7280; margin-top: 5px;">
                    Số chữ: <span id="wordCountNumber" style="font-weight: 600; color: #a855f7;">0</span>
                </div>
            </div>
        </div>
        <div class="modal-footer" style="display:flex; justify-content: flex-end; gap:10px;">
            <button id="closeChapterBtn" style="padding:10px 20px; border-radius:8px; border:1px solid #ddd; background:white;">Hủy</button>
            <button id="saveChapterBtn" style="padding:10px 30px; border-radius:8px; border:none; background:#a855f7; color:white; font-weight:600;">Thêm chương</button>
        </div>
    </div>
</div>